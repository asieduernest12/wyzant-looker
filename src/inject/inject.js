(()=>{function p(){let e,t,n,i;async function s(r){if(c().has(r))return c().get(r);let o,l;for(e=document.querySelector("#wzl_rates_iframe");!l;)console.log(o),await f(r,i),o=a(e.contentWindow.document),l=m(d(o,r)),u(o);return console.log(o),l}function u(r){for(let o of r){let l=m(o);c().set(l.name,l)}console.log("updateStudentsMap fired")}function f(r,o){if(e||(e=document.createElement("iframe"),e.setAttribute("width","300"),e.setAttribute("height","200"),e.classList.add("iframe"),e.setAttribute("id","wzl_rates_iframe"),e.setAttribute("src","https://www.wyzant.com/tutor/students/index"),document.querySelector(".wzl-container").appendChild(e)),o){let l=[...e.contentWindow.document.querySelectorAll(".ui-page-navigation")].at(-2);if(!l)throw alert("Error: next_btn_link not found");l.click()}return new Promise((l,T)=>{setInterval(()=>{e.contentWindow.document.querySelector("#studentConnectionsList:not(.ui-overlay)")&&(o=(o??0)+1,l([o,e]))},400)})}function c(){return n=n??new Map,n}function a(r){return r.querySelectorAll(".SearchTable.wyzTable tr")}function d(r,o){if(!r)throw alert("Error: Invalid trs");if(!o)throw alert("Error:student_name invalid");return[...r].find(l=>l.querySelector("a").textContent.toLowerCase()==o.toLowerCase())}function m(r){if(!r)throw alert("Error: tr invalid");return{name:r.querySelector("a:nth-of-type(1)").textContent,rate_online:r.querySelector("td:nth-child(4)")?.textContent?.match(/\$\d{2}.\d{2}/)[0],rate_inperson:r.querySelector("td:nth-child(3)")?.textContent?.match(/\$\d{2}.\d{2}/)[0]}}return{getStudent:s}}function h(){console.log("wzl script injected");let e=window.location.href.trim(),t={job_application_submit_page:/https:\/\/www.wyzant.com\/tutor\/jobs\/\d+/,message_page:/https:\/\/www.wyzant.com\/tutor\/messaging/},[n]=Object.entries(t).filter(([i,s])=>e.match(s)).map(([i])=>i);switch(console.log("wlz page target",n),n){case"students_info_page":case"message_page":console.log("wzl message_page"),A(),E();break;case"job_application_submit_page":{console.log("wzl job_application_submit_page"),g();break}default:break}}function g(){let e=document.querySelector("input[name=hourly_rate]");if(!e)throw alert("hourly_rate_input is null");e.setAttribute("type","number"),e.setAttribute("step","5"),_(document.querySelector(".hourly-rate-label + p"),e),q(),b()}function b(){let e=document.querySelector("input[type=submit]");if(!e)throw alert("input[type=submit] not found");e.focus()}function _(e,t){if(!t||!e)return;let[n]=e.textContent.match(/\d*$/);if(Number(n)>t.value)if(console.log("high offer present"),Number(n)<=70)console.log("charge exact offer"),t.value=Number(n);else{console.log("charging base plus difference");let i=.6*(Number(n)-70);t.value=Math.ceil((70+i)/5)*5}}function q(){let e=Array.from(document.querySelectorAll("select[name=template_select] > option").values()).find(({textContent:t})=>t==="default application");!e||(document.querySelector("select[name=template_select]").value=e.value,document.querySelector("textarea#personal_message").value=e.value)}async function y(e){let t=document.querySelector(".wzl-profile");if(t&&t.remove(),W(),console.log("messageDocumentClickHandler fired"),!C(e.currentTarget)){console.log("target is not a .conversation-summary-wrap");return}let i=document.querySelector(".selected p.username");if(!i)return;let[s]=i.textContent.trim().split(" "),{iframe:u,is_new:f}=z();console.log({selected_student:i}),f&&(document.querySelector(".wzl-container").appendChild(u),await new Promise(d=>{let m=setInterval(()=>{console.log("interval running"),Array.from(document.querySelector(".wzl_iframe").contentWindow.document.querySelectorAll(".job-result")).length&&(clearInterval(m),d("ready"))},400)})),M();let c;try{c=await p().getStudent(i.textContent.trim())}catch{c={name:"",rate_online:"NA",rate_inperson:"NA"}}let a=document.querySelector(".wzl-profile");a||(a=document.createElement("div"),document.querySelector(".wzl-container").appendChild(a)),a.classList.add("wzl-profile"),a.innerHTML=L(R(I(u,s),c)),document.querySelector(".wzl-card--close").addEventListener("click",()=>v(!1)),document.querySelector(".wzl-card--reset").addEventListener("click",()=>v(!0))}function C(e){return e.closest(".conversation-summary-wrap")}function A(){if(document.querySelector(".wzl-container"))return;let e=document.createElement("div");e.classList.add("wzl","wzl-container"),e.appendChild(k()),document.body.appendChild(e),console.log("wzl-container appended to body")}function L(e){if(!!e)return`
	<div class="wzl-card">
		<span class="wzl-card--close">X</span>
		<span class="wzl-card--reset">Close & Reset</span>
		<div class="wzl-card--avatar"></div>
		<div class="wzl-card--body wzl-student">
			<p class="wzl-student--username">${e.title}</p>
			<p class="wzl-student--subject">${e.time}</p>
			<p class="wzl-student--description">${e.description}</p>
		</div>
	</div>
	`}function v(e){if(document.querySelector(".wzl-card").remove(),e??!1){let{iframe:t}=z();t.remove(),Array.from(document.querySelectorAll(".conversation-summary-wrap")).filter(n=>n.classList.contains("wzl-listener-active")).forEach(n=>{n.classList.remove("wzl-listener-active"),n.removeEventListener("click",y)}),document.querySelector(".show-more a.btn").removeEventListener("click",w),S()}}function k(){let e='<div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>',t=document.createElement("div");return t.classList.add("wzl-spinner-container"),t.innerHTML=e,t}function z(){let e=document.querySelector("#wzl_iframe");if(e)return{iframe:e,is_new:!1};let t=document.createElement("iframe");return t.setAttribute("width","300"),t.setAttribute("height","200"),t.classList.add("wzl_iframe"),t.setAttribute("id","wzl_iframe"),t.setAttribute("src","https://www.wyzant.com/tutor/jobapplication/history?sort=1&pagenumber=0&pagesize=100"),{iframe:t,is_new:!0}}function E(){let e=document.querySelector(".wzl-container"),t=document.createElement("button");t.textContent="Wzl Ready",t.classList.add("wzl_indicator"),t.setAttribute("tooltip","Click to enable profile lookup of students (underlined)"),e.appendChild(t),t.addEventListener("click",j)}function j(e){let t=Array.from(document.querySelectorAll(".conversation-summary-wrap")).filter(n=>!n.classList.contains("wzl-listener-active"));t.length&&(t.forEach(n=>{n.classList.add("wzl-listener-active"),n.addEventListener("click",y)}),x()),document.querySelector(".show-more a.btn").removeEventListener("click",w),document.querySelector(".show-more a.btn").addEventListener("click",w)}function w(e){S()}function x(){document.querySelector(".wzl_indicator").classList.add("wzl_indicator_active")}function S(){document.querySelector(".wzl_indicator").classList.remove("wzl_indicator_active")}function I(e,t){console.log("findStudentResult called");let n=e.contentWindow.document.querySelectorAll(".job-result");return Array.from(n).find(u=>u.textContent.includes(t))}function R(e,t){let n={title:"Info not found",time:"Info not found",description:"Info not found in recent 100 submitted job applications",rate:-1};return e&&(n={title:e.querySelector(".job-result h4").textContent,time:`${e.querySelectorAll(".job-result p")[2].textContent}`,description:e.querySelectorAll(".job-result p")[0].textContent,rate:0}),n.time+=` online: ${t.rate_online}, inperson: ${t.rate_inperson}`,n}function W(){document.querySelector(".wzl-spinner-container").classList.add("show")}function M(){document.querySelector(".wzl-spinner-container").classList.remove("show")}h();})();
